/**
 * SCRIPT HO√ÄN TH√ÄNH VIDEO COURSERA v5.1 (T√≠ch h·ª£p Dual API Call)
 * T√°c gi·∫£: D·ª±a tr√™n nghi√™n c·ª©u c·ªßa c·ªông ƒë·ªìng.
 * Ng√†y c·∫≠p nh·∫≠t: 21/10/2025
 *
 * T√çNH NƒÇNG:
 * - S·ª≠ d·ª•ng API onDemandVideoProgresses.v1 ƒë·ªÉ c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô video (ch√≠nh).
 * - G·ª≠i th√™m y√™u c·∫ßu 'ended' qua API opencourse.v1 ƒë·ªÉ tƒÉng t√≠nh t∆∞∆°ng th√≠ch (ph·ª•).
 * - T·ª± ƒë·ªông t√¨m videoId b·∫±ng 2 ph∆∞∆°ng ph√°p:
 * 1. API Course Materials (nhanh, cho c√°c video th√¥ng th∆∞·ªùng).
 * 2. API Lecture Videos (d·ª± ph√≤ng, cho c√°c video ƒë·∫∑c bi·ªát ho·∫∑c b√†i t·∫≠p c√≥ video).
 * - T·ª± ƒë·ªông l·∫•y t·∫•t c·∫£ th√¥ng tin c·∫ßn thi·∫øt (userId, courseId, lectureId).
 * - Cung c·∫•p log chi ti·∫øt tr√™n Console ƒë·ªÉ d·ªÖ d√†ng theo d√µi.
 *
 * C√ÅCH CH·∫†Y:
 * 1. M·ªü trang b√†i gi·∫£ng video tr√™n Coursera.
 * 2. M·ªü Developer Tools (F12 ho·∫∑c Ctrl+Shift+I).
 * 3. Chuy·ªÉn sang tab "Console".
 * 4. D√°n to√†n b·ªô script n√†y v√†o v√† nh·∫•n Enter.
 * 5. G√µ l·ªánh sau v√† nh·∫•n Enter:
 * await markCurrentVideoAsComplete()
 */

// ===================== HELPER FUNCTIONS =====================

function getUserId() {
    // 1. ∆Øu ti√™n t·ª´ script tag
    const scriptTag = document.querySelector('body > script:nth-child(3)');
    if (scriptTag && scriptTag.textContent) {
        const match = scriptTag.textContent.match(/(\d+~[A-Za-z0-9-_]+)/);
        if (match && match[1]) return match[1].split('~')[0];
    }

    // 2. T·ª´ header link
    const headerLink = document.querySelector('[data-testid="page-header-wrapper"] a[data-track-app="open_course_home"]');
    if (headerLink) {
        const clickValue = headerLink.getAttribute('data-click-value');
        if (clickValue) {
            try {
                const parsed = JSON.parse(clickValue);
                if (parsed.userId) return parsed.userId.toString();
            } catch (e) { /* B·ªè qua l·ªói parsing */ }
        }
    }

    // 3. Fallback: nh·∫≠p tay
    const manual = prompt("Kh√¥ng t·ª± ƒë·ªông l·∫•y ƒë∆∞·ª£c User ID.\n\nNh·∫≠p th·ªß c√¥ng (ch·ªâ s·ªë, v√≠ d·ª•: 182559818):");
    if (manual && /^\d+$/.test(manual.trim())) {
        return manual.trim();
    }

    throw new Error("Kh√¥ng th·ªÉ l·∫•y ƒë∆∞·ª£c User ID. Script d·ª´ng l·∫°i.");
}

function getCourseContextFromUrl() {
    const match = window.location.pathname.match(/\/learn\/([^/]+)\/lecture\/([^/]+)/);
    if (!match) throw new Error("URL kh√¥ng h·ª£p l·ªá. H√£y ch·∫Øc ch·∫Øn b·∫°n ƒëang ·ªü tr√™n m·ªôt trang b√†i gi·∫£ng (lecture).");
    return { courseSlug: match[1], lectureId: match[2] };
}

async function getCourseId(slug) {
    const url = `https://www.coursera.org/api/onDemandCourses.v1?q=slug&slug=${slug}&fields=id`;
    const res = await fetch(url, { credentials: 'include' });
    if (!res.ok) throw new Error(`L·ªói khi l·∫•y courseId: ${res.status}`);
    const data = await res.json();
    const course = data.elements?.[0];
    if (!course?.id) throw new Error("Kh√¥ng t√¨m th·∫•y ID kh√≥a h·ªçc t·ª´ API.");
    return course.id;
}

// ===================== VIDEO INFO FINDERS (Primary & Fallback) =====================

/**
 * [C√°ch 1] L·∫•y videoId t·ª´ API Course Materials.
 */
async function _getVideoInfoFromMaterials(courseSlug, lectureId) {
    const url = `https://www.coursera.org/api/onDemandCourseMaterials.v2/?q=slug&slug=${courseSlug}&includes=items&fields=onDemandCourseMaterialItems.v2(name,slug,contentSummary,assetSummary)`;
    const res = await fetch(url, { credentials: 'include' });
    if (!res.ok) throw new Error(`L·ªói API Materials: ${res.status}`);
    const data = await res.json();
    const items = data?.linked?.['onDemandCourseMaterialItems.v2'];
    if (!items) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu b√†i h·ªçc trong API Materials.");

    const item = items.find(i => i.id === lectureId);
    if (!item) throw new Error(`Kh√¥ng t√¨m th·∫•y item '${lectureId}' trong API Materials.`);
    if (item.contentSummary?.typeName !== 'lecture') throw new Error("Item kh√¥ng ph·∫£i l√† m·ªôt b√†i gi·∫£ng video.");

    const def = item.assetSummary?.definition;
    if (!def?.videoId) throw new Error("Item n√†y kh√¥ng ch·ª©a videoId trong API Materials.");

    return {
        videoId: def.videoId,
        duration: def.duration || 300000 // duration t√≠nh b·∫±ng mili-gi√¢y
    };
}

/**
 * [C√°ch 2 - Fallback] L·∫•y videoId t·ª´ API Lecture Videos.
 */
async function _getVideoInfoFromLectureApi(courseId, lectureId) {
    const url = `https://www.coursera.org/api/onDemandLectureVideos.v1/${courseId}~${lectureId}?includes=video&fields=onDemandVideos.v1(id)`;
    const res = await fetch(url, { credentials: 'include' });
    if (!res.ok) throw new Error(`L·ªói API Lecture: ${res.status}`);
    const data = await res.json();
    const videoId = data?.linked?.['onDemandVideos.v1']?.[0]?.id;

    if (!videoId) {
        throw new Error("Kh√¥ng t√¨m th·∫•y videoId trong API Lecture.");
    }

    return {
        videoId: videoId,
        duration: 300000 // API n√†y kh√¥ng tr·∫£ v·ªÅ duration, ta d√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh
    };
}

/**
 * H√†m t·ªïng h·ª£p: Th·ª≠ c√°ch 1, n·∫øu th·∫•t b·∫°i th√¨ th·ª≠ c√°ch 2.
 */
async function getVideoInfo_V5(courseSlug, lectureId, courseId) {
    try {
        console.log("-> Th·ª≠ c√°ch 1: L·∫•y th√¥ng tin t·ª´ Course Materials API...");
        const videoInfo = await _getVideoInfoFromMaterials(courseSlug, lectureId);
        console.log("   Th√†nh c√¥ng b·∫±ng c√°ch 1!");
        return videoInfo;
    } catch (error) {
        console.warn(`   C√°ch 1 th·∫•t b·∫°i: ${error.message}`);
        console.log("-> Th·ª≠ c√°ch 2 (Fallback): L·∫•y th√¥ng tin t·ª´ Lecture Videos API...");
        try {
            const videoInfo = await _getVideoInfoFromLectureApi(courseId, lectureId);
            console.log("   Th√†nh c√¥ng b·∫±ng c√°ch 2!");
            return videoInfo;
        } catch (fallbackError) {
             console.error(`   C√°ch 2 c≈©ng th·∫•t b·∫°i: ${fallbackError.message}`);
             throw new Error("Kh√¥ng th·ªÉ t√¨m th·∫•y videoId b·∫±ng c·∫£ hai c√°ch. ƒê√¢y c√≥ th·ªÉ l√† b√†i ƒë·ªçc thu·∫ßn t√∫y ho·∫∑c quiz.");
        }
    }
}


// ===================== CORE ACTIONS =====================

/**
 * [H√†nh ƒë·ªông ch√≠nh] G·ª≠i y√™u c·∫ßu PUT ƒë·ªÉ c·∫≠p nh·∫≠t ti·∫øn ƒë·ªô video.
 */
async function completeVideo(userId, courseId, videoId, duration) {
    const videoProgressId = `${userId}~${courseId}~${videoId}`;
    const url = `https://www.coursera.org/api/onDemandVideoProgresses.v1/${videoProgressId}`;

    const csrfCookie = document.cookie.match(/CSRF3-Token=([^;]+)/) || document.cookie.match(/csrftoken=([^;]+)/);
    const csrfToken = csrfCookie ? csrfCookie[1] : '';
    if (!csrfToken) throw new Error("Kh√¥ng t√¨m th·∫•y CSRF token. B·∫°n ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a?");

    const headers = {
        'Content-Type': 'application/json',
        'x-requested-with': 'XMLHttpRequest',
        'x-coursera-application': 'ondemand'
    };
    if (document.cookie.includes('CSRF3-Token=')) {
        headers['x-csrf3-token'] = csrfToken;
    } else {
        headers['x-csrftoken'] = csrfToken;
    }

    const res = await fetch(url, {
        method: 'PUT',
        headers: headers,
        body: JSON.stringify({
            viewedUpTo: duration,
            videoProgressId: videoProgressId
        }),
        credentials: 'include'
    });
    
    if (res.status === 204 || res.ok) {
        return true;
    } else {
        console.error("Ph·∫£n h·ªìi l·ªói t·ª´ server (PUT request):", res);
        const errorBody = await res.text();
        console.error("N·ªôi dung l·ªói:", errorBody);
        return false;
    }
}

/**
 * [H√†nh ƒë·ªông ph·ª•] G·ª≠i y√™u c·∫ßu POST ƒë·ªÉ ƒë√°nh d·∫•u s·ª± ki·ªán 'ended'.
 */
async function markLectureAsEnded(userId, courseSlug, lectureId) {
    const apiUrl = `https://www.coursera.org/api/opencourse.v1/user/${userId}/course/${courseSlug}/item/${lectureId}/lecture/videoEvents/ended?autoEnroll=false`;
    
    try {
        const response = await fetch(apiUrl, {
            method: "POST",
            headers: {
                'Content-Type': 'application/json; charset=UTF-8',
                'x-coursera-application': 'ondemand',
                'x-requested-with': 'XMLHttpRequest'
            },
            body: JSON.stringify({ contentRequestBody: {} }),
            credentials: "include"
        });

        if (response.ok) {
            console.log("   -> Y√™u c·∫ßu b·ªï sung 'ended' th√†nh c√¥ng.");
        } else {
            console.warn(`   -> Y√™u c·∫ßu b·ªï sung 'ended' kh√¥ng th√†nh c√¥ng (Status: ${response.status}). ƒêi·ªÅu n√†y c√≥ th·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn k·∫øt qu·∫£ cu·ªëi c√πng.`);
        }
    } catch (error) {
        console.warn(`   -> L·ªói khi g·ª≠i y√™u c·∫ßu 'ended': ${error.message}`);
    }
}


// ===================== MAIN FUNCTION =====================
async function markCurrentVideoAsComplete() {
    try {
        console.clear();
        console.log("%cüöÄ B·∫ÆT ƒê·∫¶U SCRIPT HO√ÄN TH√ÄNH VIDEO v5.1 üöÄ", "color: #8A2BE2; font-weight: bold; font-size: 16px");

        // 1. L·∫•y th√¥ng tin c∆° b·∫£n
        const userId = getUserId();
        const { courseSlug, lectureId } = getCourseContextFromUrl();
        console.log(`- User ID: ${userId}`);
        console.log(`- Kh√≥a h·ªçc Slug: ${courseSlug}`);
        console.log(`- B√†i gi·∫£ng ID: ${lectureId}`);

        // 2. L·∫•y Course ID n·ªôi b·ªô
        console.log("ƒêang l·∫•y Course ID...");
        const courseId = await getCourseId(courseSlug);
        console.log(`- Course ID: ${courseId}`);

        // 3. L·∫•y Video ID v√† Duration b·∫±ng ph∆∞∆°ng ph√°p t·ªïng h·ª£p
        console.log("ƒêang l·∫•y th√¥ng tin video...");
        const { videoId, duration } = await getVideoInfo_V5(courseSlug, lectureId, courseId);
        console.log(`- Video ID: ${videoId}`);
        console.log(`- Th·ªùi l∆∞·ª£ng (ms): ${duration}`);

        // 4. G·ª≠i y√™u c·∫ßu ho√†n th√†nh ch√≠nh (PUT)
        console.log("ƒêang g·ª≠i y√™u c·∫ßu ho√†n th√†nh ch√≠nh (PUT)...");
        const success = await completeVideo(userId, courseId, videoId, duration);

        if (success) {
            // 5. G·ª≠i y√™u c·∫ßu ho√†n th√†nh ph·ª• (POST)
            console.log("ƒêang g·ª≠i y√™u c·∫ßu ho√†n th√†nh b·ªï sung (POST)...");
            await markLectureAsEnded(userId, courseSlug, lectureId);

            console.log("%c‚úÖ TH√ÄNH C√îNG! Video ƒë√£ ƒë∆∞·ª£c ƒë√°nh d·∫•u l√† ho√†n th√†nh.", "color: #00d26a; font-weight: bold; font-size: 18px");
            console.log("   -> Vui l√≤ng T·∫¢I L·∫†I TRANG (F5) ƒë·ªÉ th·∫•y d·∫•u t√≠ch xanh.");
        } else {
            throw new Error("G·ª≠i y√™u c·∫ßu ho√†n th√†nh ch√≠nh (PUT) th·∫•t b·∫°i. Ki·ªÉm tra log l·ªói ·ªü tr√™n.");
        }

    } catch (error) {
        console.error("%c‚ùå ƒê√É X·∫¢Y RA L·ªñI:", "color: red; font-weight: bold; font-size: 16px", error.message);
        console.log("   -> G·ª£i √Ω: Ki·ªÉm tra l·∫°i b·∫°n ƒë√£ ƒëƒÉng nh·∫≠p, ƒëang ·ªü ƒë√∫ng trang video, v√† kh√¥ng c√≥ ti·ªán √≠ch n√†o ch·∫∑n cookie/request.");
    }
}

// H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng
console.log(`
SCRIPT ƒê√É S·∫¥N S√ÄNG! (v5.1 - T√≠ch h·ª£p Dual API Call)
1. ƒê·∫£m b·∫£o b·∫°n ƒëang ·ªü ƒë√∫ng trang b√†i gi·∫£ng c√≥ video.
2. G√µ l·ªánh sau v√†o console v√† nh·∫•n Enter:
`);
console.log("%c   await markCurrentVideoAsComplete()", "background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 4px; font-family: monospace;");

